local M = {}

---@class (exact) SupertabExtension
---@field desc? string
---@field callback fun(): nil
---@field priority number
---@field when boolean | (fun(): boolean)
---@field halt boolean

---@type SupertabExtension[]
local extensions = {}


---Keep extensions sorted by priority
---@param ext SupertabExtension
function M.add(ext)
  for i, item in ipairs(extensions) do
    if item.priority < ext.priority then
      table.insert(extensions, i, ext)
      return
    end
  end
  table.insert(extensions, ext)
end

local function normal_tab()
  vim.api.nvim_feedkeys(vim.api.nvim_replace_termcodes("<Tab>", true, false, true), "n", false)
end

function M.press()
  for _, ext in pairs(extensions) do
    if ext.when == true or ext.when() == true then
      ext.callback()
      if ext.halt then
        return
      end
    end
  end

  normal_tab()
end

function M.debug()
  vim.print(extensions)
end


return M
