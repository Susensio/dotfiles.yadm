#!/bin/bash
# env | grep SSH
if [[ -n "$SSH_CLIENT" ]] || [[ -n "$SSH_TTY" ]]; then
  exit 0
fi

# This is way faster and more reliable than parsing pstree
ppid() {
  cat /proc/$1/stat | cut -d')' -f2 | cut -d' ' -f3
}

if [[ -n "$TMUX" ]]; then
  # look for sshd in the parent processes
  # tty="$(tmux display -p "#{client_tty}")"
  pid="$(tmux display -p "#{client_pid}")"
  while true; do
    ppid="$(ppid "$pid")"
    if grep -q 'sshd' "/proc/$ppid/comm"; then
      exit 0
    fi
    pid="$ppid"
    if [[ "$pid" -eq 1 ]]; then
      break
    fi
  done
fi

exit 1
